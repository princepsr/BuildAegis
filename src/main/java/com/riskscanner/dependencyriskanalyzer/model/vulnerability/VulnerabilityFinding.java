package com.riskscanner.dependencyriskanalyzer.model.vulnerability;

import com.riskscanner.dependencyriskanalyzer.model.DependencyCoordinate;

import java.time.Instant;
import java.util.List;
import java.util.Optional;

/**
 * Represents a vulnerability finding with contextual risk assessment.
 *
 * <p>Contains the raw vulnerability information plus computed risk metrics,
 * confidence levels, and optional suppression information.
 */
public class VulnerabilityFinding {

    private final String id;
    private final DependencyCoordinate dependency;
    private final Vulnerability vulnerability;
    private final Severity rawSeverity;
    private final RiskScore riskScore;
    private final ConfidenceLevel confidenceLevel;
    private final int confidenceScore;
    private final boolean suppressed;
    private final SuppressionInfo suppressionInfo;
    private final List<String> sources;
    private final Instant detectedAt;
    private final String analysisNotes;

    private VulnerabilityFinding(Builder builder) {
        this.id = builder.id;
        this.dependency = builder.dependency;
        this.vulnerability = builder.vulnerability;
        this.rawSeverity = builder.rawSeverity;
        this.riskScore = builder.riskScore;
        this.confidenceLevel = builder.confidenceLevel;
        this.confidenceScore = builder.confidenceScore;
        this.suppressed = builder.suppressed;
        this.suppressionInfo = builder.suppressionInfo;
        this.sources = List.copyOf(builder.sources);
        this.detectedAt = builder.detectedAt;
        this.analysisNotes = builder.analysisNotes;
    }

    /**
     * Creates a new builder for constructing VulnerabilityFinding instances.
     */
    public static Builder builder() {
        return new Builder();
    }

    // Getters
    public String getId() {
        return id;
    }

    public DependencyCoordinate getDependency() {
        return dependency;
    }

    public Vulnerability getVulnerability() {
        return vulnerability;
    }

    public Severity getRawSeverity() {
        return rawSeverity;
    }

    public RiskScore getRiskScore() {
        return riskScore;
    }

    public ConfidenceLevel getConfidenceLevel() {
        return confidenceLevel;
    }

    public int getConfidenceScore() {
        return confidenceScore;
    }

    public boolean isSuppressed() {
        return suppressed;
    }

    public Optional<SuppressionInfo> getSuppressionInfo() {
        return Optional.ofNullable(suppressionInfo);
    }

    public List<String> getSources() {
        return sources;
    }

    public Instant getDetectedAt() {
        return detectedAt;
    }

    public Optional<String> getAnalysisNotes() {
        return Optional.ofNullable(analysisNotes);
    }

    /**
     * Gets the effective severity considering suppression.
     */
    public Severity getEffectiveSeverity() {
        return suppressed ? Severity.INFO : rawSeverity;
    }

    /**
     * Gets the effective risk score considering suppression.
     */
    public int getEffectiveRiskScore() {
        return suppressed ? 0 : riskScore.getScore();
    }

    @Override
    public String toString() {
        return String.format("VulnerabilityFinding{id='%s', dependency=%s, severity=%s, risk=%s, confidence=%s, suppressed=%s}",
            id, dependency, rawSeverity, riskScore, confidenceLevel, suppressed);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;

        VulnerabilityFinding that = (VulnerabilityFinding) o;
        return id.equals(that.id);
    }

    @Override
    public int hashCode() {
        return id.hashCode();
    }

    /**
     * Builder pattern for constructing VulnerabilityFinding instances.
     */
    public static class Builder {
        private String id;
        private DependencyCoordinate dependency;
        private Vulnerability vulnerability;
        private Severity rawSeverity;
        private RiskScore riskScore;
        private ConfidenceLevel confidenceLevel;
        private int confidenceScore;
        private boolean suppressed;
        private SuppressionInfo suppressionInfo;
        private List<String> sources = List.of();
        private Instant detectedAt;
        private String analysisNotes;

        public Builder id(String id) {
            this.id = id;
            return this;
        }

        public Builder dependency(DependencyCoordinate dependency) {
            this.dependency = dependency;
            return this;
        }

        public Builder vulnerability(Vulnerability vulnerability) {
            this.vulnerability = vulnerability;
            return this;
        }

        public Builder rawSeverity(Severity rawSeverity) {
            this.rawSeverity = rawSeverity;
            return this;
        }

        public Builder riskScore(RiskScore riskScore) {
            this.riskScore = riskScore;
            return this;
        }

        public Builder confidenceLevel(ConfidenceLevel confidenceLevel) {
            this.confidenceLevel = confidenceLevel;
            return this;
        }

        public Builder confidenceScore(int confidenceScore) {
            this.confidenceScore = confidenceScore;
            return this;
        }

        public Builder suppressed(boolean suppressed) {
            this.suppressed = suppressed;
            return this;
        }

        public Builder suppressionInfo(SuppressionInfo suppressionInfo) {
            this.suppressionInfo = suppressionInfo;
            return this;
        }

        public Builder sources(List<String> sources) {
            this.sources = sources;
            return this;
        }

        public Builder detectedAt(Instant detectedAt) {
            this.detectedAt = detectedAt;
            return this;
        }

        public Builder analysisNotes(String analysisNotes) {
            this.analysisNotes = analysisNotes;
            return this;
        }

        public VulnerabilityFinding build() {
            if (id == null || id.isBlank()) {
                throw new IllegalArgumentException("ID is required");
            }
            if (dependency == null) {
                throw new IllegalArgumentException("Dependency is required");
            }
            if (vulnerability == null) {
                throw new IllegalArgumentException("Vulnerability is required");
            }
            if (rawSeverity == null) {
                throw new IllegalArgumentException("Raw severity is required");
            }
            if (riskScore == null) {
                throw new IllegalArgumentException("Risk score is required");
            }
            if (confidenceLevel == null) {
                throw new IllegalArgumentException("Confidence level is required");
            }
            if (detectedAt == null) {
                this.detectedAt = Instant.now();
            }

            return new VulnerabilityFinding(this);
        }
    }

    /**
     * Information about vulnerability suppression.
     */
    public static class SuppressionInfo {
        private final String reason;
        private final String suppressedBy;
        private final Instant suppressedAt;
        private final String justification;

        public SuppressionInfo(String reason, String suppressedBy, String justification) {
            this.reason = reason;
            this.suppressedBy = suppressedBy;
            this.suppressedAt = Instant.now();
            this.justification = justification;
        }

        public String getReason() {
            return reason;
        }

        public String getSuppressedBy() {
            return suppressedBy;
        }

        public Instant getSuppressedAt() {
            return suppressedAt;
        }

        public String getJustification() {
            return justification;
        }

        @Override
        public String toString() {
            return String.format("SuppressionInfo{reason='%s', by='%s', at=%s}",
                reason, suppressedBy, suppressedAt);
        }
    }
}
