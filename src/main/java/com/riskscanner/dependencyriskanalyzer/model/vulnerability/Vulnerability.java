package com.riskscanner.dependencyriskanalyzer.model.vulnerability;

import java.time.Instant;
import java.util.List;
import java.util.Optional;

/**
 * Represents a security vulnerability with normalized data from various sources.
 *
 * <p>This model provides a unified representation of vulnerability information
 * from multiple providers (OSV, NVD, GitHub Advisory, Maven Central).
 */
public class Vulnerability {

    private final String id;
    private final VulnerabilitySource source;
    private final String title;
    private final String description;
    private final Severity severity;
    private final List<String> affectedVersions;
    private final VersionRange versionRange;
    private final List<String> references;
    private final List<String> aliases; // CVEs, GHSA IDs, etc.
    private final Instant publishedAt;
    private final Instant updatedAt;
    private final String cweId; // Common Weakness Enumeration
    private final Double cvssScore;
    private final String cvssVector;

    private Vulnerability(Builder builder) {
        this.id = builder.id;
        this.source = builder.source;
        this.title = builder.title;
        this.description = builder.description;
        this.severity = builder.severity;
        this.affectedVersions = List.copyOf(builder.affectedVersions);
        this.versionRange = builder.versionRange;
        this.references = List.copyOf(builder.references);
        this.aliases = List.copyOf(builder.aliases);
        this.publishedAt = builder.publishedAt;
        this.updatedAt = builder.updatedAt;
        this.cweId = builder.cweId;
        this.cvssScore = builder.cvssScore;
        this.cvssVector = builder.cvssVector;
    }

    /**
     * Creates a new builder for constructing Vulnerability instances.
     */
    public static Builder builder() {
        return new Builder();
    }

    // Getters
    public String getId() {
        return id;
    }

    public VulnerabilitySource getSource() {
        return source;
    }

    public String getTitle() {
        return title;
    }

    public String getDescription() {
        return description;
    }

    public Severity getSeverity() {
        return severity;
    }

    public List<String> getAffectedVersions() {
        return affectedVersions;
    }

    public Optional<VersionRange> getVersionRange() {
        return Optional.ofNullable(versionRange);
    }

    public List<String> getReferences() {
        return references;
    }

    public List<String> getAliases() {
        return aliases;
    }

    public Instant getPublishedAt() {
        return publishedAt;
    }

    public Instant getUpdatedAt() {
        return updatedAt;
    }

    public Optional<String> getCweId() {
        return Optional.ofNullable(cweId);
    }

    public Optional<Double> getCvssScore() {
        return Optional.ofNullable(cvssScore);
    }

    public Optional<String> getCvssVector() {
        return Optional.ofNullable(cvssVector);
    }

    /**
     * Checks if this vulnerability affects the given version.
     */
    public boolean affectsVersion(String version) {
        // Check exact version matches first
        if (affectedVersions.contains(version)) {
            return true;
        }
        
        // Check version range if available
        if (versionRange != null) {
            return versionRange.includes(version);
        }
        
        return false;
    }

    /**
     * Checks if this vulnerability affects the given version exactly.
     */
    public boolean affectsVersionExact(String version) {
        return affectedVersions.contains(version);
    }

    /**
     * Gets the version match quality (0.0-1.0) for the given version.
     */
    public double getVersionMatchQuality(String version) {
        if (affectsVersionExact(version)) {
            return 1.0; // Exact match
        }
        
        if (versionRange != null && versionRange.includes(version)) {
            return 0.8; // Range match
        }
        
        return 0.0; // No match
    }

    @Override
    public String toString() {
        return String.format("Vulnerability{id='%s', source=%s, severity=%s, title='%s'}",
            id, source, severity, title);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        
        Vulnerability that = (Vulnerability) o;
        return id.equals(that.id) && source == that.source;
    }

    @Override
    public int hashCode() {
        return id.hashCode() * 31 + source.hashCode();
    }

    /**
     * Builder pattern for constructing Vulnerability instances.
     */
    public static class Builder {
        private String id;
        private VulnerabilitySource source;
        private String title;
        private String description;
        private Severity severity;
        private List<String> affectedVersions = List.of();
        private VersionRange versionRange;
        private List<String> references = List.of();
        private List<String> aliases = List.of();
        private Instant publishedAt;
        private Instant updatedAt;
        private String cweId;
        private Double cvssScore;
        private String cvssVector;

        public Builder id(String id) {
            this.id = id;
            return this;
        }

        public Builder source(VulnerabilitySource source) {
            this.source = source;
            return this;
        }

        public Builder title(String title) {
            this.title = title;
            return this;
        }

        public Builder description(String description) {
            this.description = description;
            return this;
        }

        public Builder severity(Severity severity) {
            this.severity = severity;
            return this;
        }

        public Builder affectedVersions(List<String> affectedVersions) {
            this.affectedVersions = affectedVersions;
            return this;
        }

        public Builder versionRange(VersionRange versionRange) {
            this.versionRange = versionRange;
            return this;
        }

        public Builder references(List<String> references) {
            this.references = references;
            return this;
        }

        public Builder aliases(List<String> aliases) {
            this.aliases = aliases;
            return this;
        }

        public Builder publishedAt(Instant publishedAt) {
            this.publishedAt = publishedAt;
            return this;
        }

        public Builder updatedAt(Instant updatedAt) {
            this.updatedAt = updatedAt;
            return this;
        }

        public Builder cweId(String cweId) {
            this.cweId = cweId;
            return this;
        }

        public Builder cvssScore(Double cvssScore) {
            this.cvssScore = cvssScore;
            return this;
        }

        public Builder cvssVector(String cvssVector) {
            this.cvssVector = cvssVector;
            return this;
        }

        public Vulnerability build() {
            if (id == null || id.isBlank()) {
                throw new IllegalArgumentException("Vulnerability ID is required");
            }
            if (source == null) {
                throw new IllegalArgumentException("Vulnerability source is required");
            }
            if (severity == null) {
                throw new IllegalArgumentException("Vulnerability severity is required");
            }
            
            return new Vulnerability(this);
        }
    }
}
